<html>
<head>
    <style type="text/css">
    
        canvas, img {
            border: 1px solid black;
        }
    
    </style>
    
</head>
<body style="background-color:#2c3553;">

<img src="sulust.png" id="img1">
<img src="damage.png" id="img2">
<img src="damagemask.png" id="img3">

<canvas style="display:none;" id="constructcanvas"></canvas>

<p>Blended image<br><canvas id="canvas"></canvas></p>
<script>
window.onload = function () {
    console.log(new Date().getTime());
  
    var canvas = document.getElementById("canvas");
    var context = canvas.getContext("2d");
    var canvas2 = document.getElementById("constructcanvas");
    var context2 = canvas2.getContext("2d");

    var width = img1.width;
    var height = img1.height;
    
    context2.drawImage(img1, 0, 0);
    var image1 = context2.getImageData(0, 0, width, height);
    context2.clearRect ( 0 , 0 , 2000, 2000 );
    
    image1 = applyDamage(image1, 100, 0);
    
    //image1 = applyDamage(image1, -100, 0);
    
    //image1 = applyDamage(image1, 0, 90);
    //image1 = applyDamage(image1, 0, -90);
    
    context.putImageData(image1, 0, 0);
    
    
   
    
    function applyDamage(image1, x, y){
    
        
            var img1 = document.getElementById('img1');
            var img2 = document.getElementById('img2');
            var img3 = document.getElementById('img3');
            var canvas = document.getElementById("canvas");
            var context = canvas.getContext("2d");
            var canvas2 = document.getElementById("constructcanvas");
            var context2 = canvas2.getContext("2d");
            var width = img1.width;
            var height = img1.height;
            canvas.width = width;
            canvas.height = height;

            var pixels = 4 * width * height;
            
            var imageData1 = image1.data;
            
            context2.drawImage(img2, x, y);
            var image2 = context2.getImageData(0, 0, img2.width, img2.height);
            var imageData2 = image2.data;
            context2.clearRect ( 0 , 0 , 2000, 2000 );
             
            context2.drawImage(img3, x, y);
            var image3 = context2.getImageData(0, 0, img3.width, img3.height);
            var imageData3 = image3.data;
            context2.clearRect ( 0 , 0 , 2000, 2000 );
            
            
            while (pixels) {
                var r = pixels-4;
                var g = pixels-3;
                var b = pixels-2;
                var a = pixels-1;
                
                var a1 = imageData1[a];
                var a2 = imageData2[a];
                var a3 = 255 - imageData3[a];
                
                if (a3 < 255 ){
                    var na = (a1 < a3) ? a1 : a3;
                    imageData1[a] = na;
                        
                }
                
                
                
                if (a1 == 0 || a2 == 0){
                        pixels -= 4;
                        continue;
                }
                
                
                
                    
                var m = a2 / 255;
                //alphaComponent = imageData.data[((50*(imageData.width*4)) + (200*4)) + 3];
                imageData1[r] = imageData1[r] * (1-m) + imageData2[r] * m;
                imageData1[g] = imageData1[g] * (1-m) + imageData2[g] * m;
                imageData1[b] = imageData1[b] * (1-m) + imageData2[b] * m;
                
                
                
                
                
                
                pixels -= 4;
                
                
            }
            image1.data = imageData1;
            //context.putImageData(image1, 0, 0);
            
        
        
        console.log(new Date().getTime());
        return image1;
    }
};
</script>

</body>
</html>
